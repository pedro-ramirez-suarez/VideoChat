<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Videochat by pedro-ramirez-suarez</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Videochat</h1>
      <h2 class="project-tagline">A video chat with HTML5 + javascript + Server Sent Events</h2>
      <a href="https://github.com/pedro-ramirez-suarez/VideoChat" class="btn">View on GitHub</a>
      <a href="https://github.com/pedro-ramirez-suarez/VideoChat/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/pedro-ramirez-suarez/VideoChat/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p>I like to play with technology, push it and use it on not very common scenarios, this project is just that, some technology(SSE) being used for something(Video Conference) that is better acomplished with another technology, in this case WebRTC.</p>

<p><img src="https://raw.githubusercontent.com/pedro-ramirez-suarez/VideoChat/gh-pages/images/videochat.png" alt="demo"></p>

<p>There are many things that can be done better, but the purpose of this project, is not to have a perfect piece of code, but to have a working proof of concept.</p>

<h2>
<a id="why-server-sent-events" class="anchor" href="#why-server-sent-events" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why Server Sent Events?</h2>

<p>Compared with WebSockets, Server Sent Events apps are very easy to build with Asp.Net MVC, and with the help of <a href="https://github.com/pedro-ramirez-suarez/needletailtools/wiki/Using-Needletail.Mvc" target="_blank">Needletail.MVC</a> that helps you to build SSE apps without breaking your MVC pattern, it's even easier.</p>

<p>The main limitations of using SSE for this kind of application are:</p>

<ul>
<li>SSE is not peer to peer, neither bi-directional, nor full duplex, so it's slower.</li>
<li>The ammount of data received and sent is bigger with SSE, to upload data to the server, you need to send it as a file, or as a string, if you send strings you need to be sure that those are Base64(which increase the size) otherwise the server may reject the request, also, when sending data to the client, you can only serve files or strings, as incomming connections, you need to convert those strings to Base64 or the server may not send the info that you want.</li>
<li>Trial and error is the way you sicronize the image and audio.</li>
</ul>

<p>The application supports only two users, but with minor changes it may support many more.</p>

<p>It uses  the following open source projects:</p>

<ul>
<li>Bootstap</li>
<li>JQuery</li>
<li>Recorderjs</li>
<li>libmp3lame-js</li>
</ul>

<p>I modified the Recorderjs library to record mono audio instead of stereo and also to automatically convert the wav file to mp3 file using libmp3lame-js.</p>

<p><b>Important </b> SSE is not supported on Internet Explorer(any version), also, sometimes  SSE does not work fine on IIS Express.</p>

<h2>
<a id="points-of-interest" class="anchor" href="#points-of-interest" aria-hidden="true"><span class="octicon octicon-link"></span></a>Points of interest</h2>

<p>The code in the server that receives the sequence of images and the audio and sends it to the other user is very simple:</p>

<pre><code>
        [HttpPost]
        public JsonResult PushVideoFragment()
        {
            //Get the audio stream and store it on a local collection
            MemoryStream ms = new MemoryStream();
            Request.Files[0].InputStream.CopyTo(ms);
            ms.Position = 0;
            string id = Guid.NewGuid().ToString().Replace("-", "");
            audios.Add(id, ms);
            //store the images locally
            var frames = new List();
            foreach (string k in Request.Form.Keys)
            {
                frames.Add(Request.Form[k]);
            }

            //send the audio to everyone but me
            var receivers = RemoteController.Users.Where(u =&gt; u != Request.Cookies["videoChatUser"].Value);
            foreach (var u in receivers)
            {
                dynamic call = new ClientCall { CallerId = Request.Cookies["videoChatUser"].Value, ClientId = u };
                //since we cannot send the audio, we just send the ID of the audio that we just received
                call.updateVideoFragment(id, frames, Request.Cookies["videoChatUser"].Value);
                RemoteExecution.ExecuteOnClient(call, false);
            }
            return Json(new { success = true });
        }

</code></pre>

<p>The most important pieces of code are in the Javascript code</p>

<pre><code>//Send all the data to the server after the audio is converted
function sendAudioAndVideo() {
    var formData = new FormData();
    //set the frames
    for (var x in frames) {
        //only process first 10 frames, this is to sync video and audio
        if (x &gt; 9)
            break;
        //append a new frame
        formData.append('frame' + x, frames[x]);
    }
    //clear the frames
    frames = [];
    //set the audio
    formData.append('edition[audio]', currentAudio);
    //Send the audio to the server as a file attachment
    $.ajax({
        type: 'POST',
        url: pushVideoFragmentUrl,
        data: formData,
        contentType: false,
        cache: false,
        processData: false,
    });
}

//This function is "invoked" from the MVC HomeController
function updateVideoFragment(id, remoteFrames, user) {
    //update frames
    for (var x in remoteFrames) {
        if (remoteFrames[x].length == 0)
            continue;
        pendingFrames.push(remoteFrames[x]);
    }

    //set the user who send the video
    $('#remoteUser').html(user);
    //we are not allowed to send the audio file directly, so we just set the src of the stream
    //play new audio
    $("#audio").attr("src", updateAudioUrl + '/' + id);
    $("#audio")[0].play();
}</code></pre>

<h4>
<a id="since-only-one-browseror-tab-is-allowed-to-access-the-camera-and-microphone-you-need-to-use-two-computers-to-test-the-application" class="anchor" href="#since-only-one-browseror-tab-is-allowed-to-access-the-camera-and-microphone-you-need-to-use-two-computers-to-test-the-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Since only one browser(or tab) is allowed to access the camera and microphone, you need to use two computers to test the application</h4>

<p><b>Enjoy!</b></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/pedro-ramirez-suarez/VideoChat">Videochat</a> is maintained by <a href="https://github.com/pedro-ramirez-suarez">pedro-ramirez-suarez</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>

